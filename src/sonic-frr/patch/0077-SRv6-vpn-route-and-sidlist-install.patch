From 1d1ff47a5fc8fbc373bcdfb1630a5331dd586eef Mon Sep 17 00:00:00 2001
From: "guozhongfeng.gzf" <guozhongfeng.gzf@alibaba-inc.com>
Date: Thu, 9 Jan 2025 10:24:42 +0800
Subject: [PATCH] SRv6-vpn-route-and-sidlist-install

Signed-off-by: guozhongfeng.gzf <guozhongfeng.gzf@alibaba-inc.com>
---
 lib/srv6.h           |  1 +
 zebra/zebra_dplane.c |  9 +++++++++
 zebra/zebra_dplane.h |  5 +++++
 zebra/zebra_srv6.h   | 14 ++++++++++++++
 4 files changed, 29 insertions(+)

diff --git a/lib/srv6.h b/lib/srv6.h
index ee69f41ee..5697dadcc 100644
--- a/lib/srv6.h
+++ b/lib/srv6.h
@@ -193,6 +193,7 @@ struct nexthop_srv6 {
 
 	/* SRv6 Headend-behaviour */
 	struct seg6_seg_stack *seg6_segs;
+	struct in6_addr seg6_src;
 };
 
 /* SID format type */
diff --git a/zebra/zebra_dplane.c b/zebra/zebra_dplane.c
index 74ea14432..f1c184f3b 100644
--- a/zebra/zebra_dplane.c
+++ b/zebra/zebra_dplane.c
@@ -26,6 +26,7 @@
 #include "zebra/zebra_pbr.h"
 #include "zebra/zebra_neigh.h"
 #include "zebra/zebra_tc.h"
+#include "zebra/zebra_srv6.h"
 #include "printfrr.h"
 
 /* Memory types */
@@ -424,6 +425,7 @@ struct zebra_dplane_ctx {
 	/* Support info for different kinds of updates */
 	union {
 		struct dplane_route_info rinfo;
+		struct zebra_srv6_sidlist sidlist;
 		struct zebra_lsp lsp;
 		struct dplane_pw_info pw;
 		struct dplane_br_port_info br_port;
@@ -993,6 +995,13 @@ uint32_t dplane_ctx_queue_count(struct dplane_ctx_list_head *q)
 	return dplane_ctx_list_count(q);
 }
 
+const struct zebra_srv6_sidlist *dplane_ctx_get_sidlist(const struct zebra_dplane_ctx *ctx)
+{
+	DPLANE_CTX_VALID(ctx);
+
+	return &(ctx->u.sidlist);
+}
+
 /*
  * Accessors for information from the context object
  */
diff --git a/zebra/zebra_dplane.h b/zebra/zebra_dplane.h
index 2f9505ecb..bc8279af4 100644
--- a/zebra/zebra_dplane.h
+++ b/zebra/zebra_dplane.h
@@ -130,6 +130,10 @@ enum dplane_op_e {
 	DPLANE_OP_PIC_NH_UPDATE,
 	DPLANE_OP_PIC_NH_DELETE,
 
+	DPLANE_OP_SID_LIST_INSTALL,
+	DPLANE_OP_SID_LIST_UPDATE,
+	DPLANE_OP_SID_LIST_DELETE,
+
 	/* LSP update */
 	DPLANE_OP_LSP_INSTALL,
 	DPLANE_OP_LSP_UPDATE,
@@ -617,6 +621,7 @@ const struct nh_grp *
 dplane_ctx_get_nhe_nh_grp(const struct zebra_dplane_ctx *ctx);
 uint16_t dplane_ctx_get_nhe_nh_grp_count(const struct zebra_dplane_ctx *ctx);
 
+const struct zebra_srv6_sidlist *dplane_ctx_get_sidlist(const struct zebra_dplane_ctx *ctx);
 /* Accessors for LSP information */
 
 /* Init the internal LSP data struct - necessary before adding to it.
diff --git a/zebra/zebra_srv6.h b/zebra/zebra_srv6.h
index 1599fd7ad..6ef1c7fc6 100644
--- a/zebra/zebra_srv6.h
+++ b/zebra/zebra_srv6.h
@@ -209,6 +209,20 @@ struct zebra_srv6 {
 	struct list *sid_blocks;
 };
 
+#define SRV6_SEGMENTLIST_NAME_MAX_LENGTH 64
+#define SRV6_SID_INDEX_MAX_NUM 8
+
+struct zebra_srv6_segment_entry {
+	uint32_t index_;
+	struct ipaddr srv6_sid_value_;
+};
+struct zebra_srv6_sidlist {
+	char sidlist_name_[SRV6_SEGMENTLIST_NAME_MAX_LENGTH];
+	uint32_t segment_count_;
+	struct zebra_srv6_segment_entry segments_[SRV6_SID_INDEX_MAX_NUM];
+};
+
+
 /* declare hooks for the basic API, so that it can be specialized or served
  * externally. Also declare a hook when those functions have been registered,
  * so that any external module wanting to replace those can react
-- 
2.45.2.windows.1

